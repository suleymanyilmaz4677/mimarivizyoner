<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GÃ¶rsel Prototip: Eskizden GerÃ§ekliÄŸe</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <!-- OpenCV.js CDN (Canny Edge Detection iÃ§in gerekli) -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <div id="status-ribbon" class="mb-6 p-3 rounded-xl shadow-lg font-semibold text-center transition-all duration-300">
        <!-- Buraya dinamik olarak WebGPU veya DEMO durumu yazÄ±lacak -->
    </div>

    <main class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Sol Panel: GiriÅŸ ve Ayarlar -->
        <div class="lg:col-span-1 space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-4">Eskiz & Stil GiriÅŸi</h1>

            <!-- Durum ve Hata MesajlarÄ± -->
            <div id="message-box" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

            <!-- 1. Eskiz YÃ¼kleme -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">1. Eskiz YÃ¼kle (PNG/JPG, maks 5MB)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-500 transition" id="file-drop-area">
                    <input id="sketch-file" type="file" accept=".png, .jpg, .jpeg" class="hidden">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m-4-4h4m-4 0v4m-4-4l3.172-3.172a4 4 0 005.656 0L36 32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium text-indigo-600 hover:text-indigo-500">TÄ±kla yÃ¼kle</span> veya sÃ¼rÃ¼kle bÄ±rak
                        </p>
                        <p class="text-xs text-gray-500">PNG, JPG</p>
                    </div>
                </div>
            </div>

            <!-- Eskiz Ã–nizleme -->
            <div id="sketch-preview-container" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ã–nizleme</label>
                <img id="sketch-preview" class="w-full h-auto rounded-lg shadow-md border object-cover" src="#" alt="Eskiz Ã–nizlemesi">
                <button id="clear-sketch" class="mt-2 text-xs text-red-600 hover:text-red-800 transition">Eskizi Temizle</button>
            </div>
            <!-- Canny Ã§Ä±ktÄ±sÄ±, API'ye gÃ¶ndermeden Ã¶nce base64'e Ã§evrilecek buradan okunacak -->
            <canvas id="canny-canvas" class="hidden w-full h-auto rounded-lg shadow-md border object-cover"></canvas> 

            <!-- 2. Stil Metni (Prompt) -->
            <div>
                <label for="prompt-text" class="block text-sm font-medium text-gray-700 mb-2">2. Malzeme ve Stil (Prompt)</label>
                <textarea id="prompt-text" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="Ã–rn: 'Rustik ahÅŸap cephe, Ã§atÄ± katÄ± pencereleri, sonbahar yapraklarÄ±.'"></textarea>
            </div>

            <!-- 3. Sahne Tipi -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">3. Sahne Tipi SeÃ§</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="scene-option-label" data-scene="OutdoorDay">GÃ¼ndÃ¼z (DÄ±ÅŸ Mekan)</label>
                    <label class="scene-option-label" data-scene="OutdoorSunset">GÃ¼nbatÄ±mÄ± (DÄ±ÅŸ Mekan)</label>
                    <label class="scene-option-label" data-scene="OutdoorNight">Gece (DÄ±ÅŸ Mekan)</label>
                    <label class="scene-option-label" data-scene="Indoor">Ä°Ã§ Mekan</label>
                </div>
            </div>

            <!-- OluÅŸtur Butonu -->
            <button id="generate-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-[1.01]">
                <span id="generate-text">GÃ¶rsel OluÅŸtur</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </button>
        </div>

        <!-- SaÄŸ Panel: SonuÃ§ GÃ¶rseli ve Alternatifler -->
        <div class="lg:col-span-2 space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-4">SonuÃ§ GÃ¶rseli</h2>

            <!-- SonuÃ§ GÃ¶rseli -->
            <div class="relative bg-gray-200 rounded-xl overflow-hidden shadow-xl aspect-video flex items-center justify-center p-4">
                <img id="result-image" class="w-full h-full object-contain rounded-lg" src="https://placehold.co/800x450/e0e0e0/555?text=SonuÃ§+Burada+GÃ¶zÃ¼kecek" alt="Ãœretim Sonucu">
                <div id="result-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-70 text-white flex items-center justify-center rounded-xl transition duration-300 hidden">
                    <span id="overlay-text" class="text-xl font-semibold text-center">LÃ¼tfen bir eskiz yÃ¼kleyin ve "OluÅŸtur"a tÄ±klayÄ±n.</span>
                </div>
            </div>

            <!-- Alternatif Sahne ButonlarÄ± -->
            <div id="alternative-scenes" class="pt-4 border-t hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Alternatif Sahne Denemeleri</h3>
                <div class="grid grid-cols-3 gap-4" id="alternative-buttons-container">
                    <!-- Alternatif butonlar buraya JS ile yÃ¼klenecek -->
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Zorunlu Global DeÄŸiÅŸkenler (Canvas ortamÄ± iÃ§in)
        const appId = window.__app_id || 'default-app-id';
        const firebaseConfigRaw = window.__firebase_config;
        let firebaseConfig = {};
        if (firebaseConfigRaw) {
            try {
                // @ts-ignore
                firebaseConfig = JSON.parse(firebaseConfigRaw);
            } catch (e) {
                console.error("Firebase config Ã§Ã¶zÃ¼mlemesi hatasÄ±:", e);
            }
        }
        const initialAuthToken = window.__initial_auth_token || null;


        // KONTROL BAYRAÄžI: API kullanÄ±mÄ±nÄ± tamamen kapatmak iÃ§in
        // FALSE ise, WebGPU destekli cihazlarda sadece Canny Ã§Ä±ktÄ±sÄ± gÃ¶sterilir (100% kotasÄ±z).
        const USE_GEMINI_API = false; 

        // Sabitler
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5MB
        const DEMO_LIBRARY = {
            OutdoorDay: ['/demo-samples/outdoor-day-1.jpg','/demo-samples/outdoor-day-2.jpg'],
            OutdoorSunset: ['/demo-samples/outdoor-sunset-1.jpg','/demo-samples/outdoor-sunset-2.jpg'],
            OutdoorNight: ['/demo-samples/outdoor-night-1.jpg','/demo-samples/outdoor-night-2.jpg'],
            Indoor: ['/demo-samples/indoor-1.jpg','/demo-samples/indoor-2.jpg','/demo-samples/indoor-3.jpg'],
        };
        const SCENE_NAMES_TR = {
            OutdoorDay: "GÃ¼ndÃ¼z (DÄ±ÅŸ Mekan)",
            OutdoorSunset: "GÃ¼nbatÄ±mÄ±",
            OutdoorNight: "Gece (DÄ±ÅŸ Mekan)",
            Indoor: "Ä°Ã§ Mekan",
        };

        // UI Elementleri
        const sketchFile = document.getElementById('sketch-file');
        const fileDropArea = document.getElementById('file-drop-area');
        const sketchPreview = document.getElementById('sketch-preview');
        const sketchPreviewContainer = document.getElementById('sketch-preview-container');
        const clearSketchButton = document.getElementById('clear-sketch');
        const cannyCanvas = document.getElementById('canny-canvas');
        const promptText = document.getElementById('prompt-text');
        const generateButton = document.getElementById('generate-button');
        const generateText = document.getElementById('generate-text');
        const spinner = document.getElementById('spinner');
        const resultImage = document.getElementById('result-image');
        const messageBox = document.getElementById('message-box');
        const statusRibbon = document.getElementById('status-ribbon');
        const resultOverlay = document.getElementById('result-overlay');
        const overlayText = document.getElementById('overlay-text');
        const alternativeButtonsContainer = document.getElementById('alternative-buttons-container');
        const alternativeScenesContainer = document.getElementById('alternative-scenes');

        // Durum YÃ¶netimi
        let currentSketchFile = null;
        let selectedScene = 'OutdoorDay';
        let isWebGPUSupported = false;
        let isCvReady = false;

        // Helper Fonksiyonlar
        const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const showMessage = (text, type = 'error') => {
            messageBox.textContent = text;
            messageBox.className = `p-3 text-sm rounded-xl transition duration-300 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.classList.remove('hidden');
        };
        const hideMessage = () => messageBox.classList.add('hidden');
        const setGenerating = (isGenerating) => {
            generateButton.disabled = isGenerating;
            spinner.classList.toggle('hidden', !isGenerating);
            generateText.textContent = isGenerating ? 'OluÅŸturuluyor...' : 'GÃ¶rsel OluÅŸtur';
        };

        // WebGPU KontrolÃ¼ ve Modu Belirleme
        const checkWebGPU = () => {
            // @ts-ignore
            isWebGPUSupported = navigator.gpu != null;

            if (isWebGPUSupported) {
                if (USE_GEMINI_API) {
                    statusRibbon.textContent = "âœ… YEREL Mod (API Destekli Ãœretim): Canvas KotasÄ± kullanÄ±larak fotogerÃ§ekÃ§i Ã§Ä±ktÄ± alÄ±nÄ±r.";
                    statusRibbon.classList.add('bg-green-200', 'text-green-800');
                } else {
                    // KullanÄ±cÄ±nÄ±n talep ettiÄŸi 100% kotasÄ±z, statik mod.
                    statusRibbon.textContent = "ðŸ’» YEREL Mod (Canny Ã‡Ä±ktÄ±sÄ±): API Ã§aÄŸrÄ±sÄ± KAPALI. Sadece OpenCV Ã§Ä±ktÄ±sÄ± gÃ¶sterilir.";
                    statusRibbon.classList.add('bg-blue-200', 'text-blue-800');
                }
            } else {
                statusRibbon.textContent = "âŒ DEMO Modu: WebGPU Desteklenmiyor. Ã–nceden yÃ¼klenmiÅŸ gÃ¶rseller kullanÄ±lacak.";
                statusRibbon.classList.add('bg-yellow-200', 'text-yellow-800');
                isCvReady = true; 
            }
        };

        // OpenCV HazÄ±r Olma Durumu
        window.onload = function() {
            checkWebGPU();

            if (isWebGPUSupported) {
                // Sadece WebGPU destekleniyorsa OpenCV'nin yÃ¼klenmesini bekleriz.
                // @ts-ignore
                if (typeof cv !== 'undefined') {
                    isCvReady = true;
                } else {
                    const checkCv = setInterval(() => {
                        // @ts-ignore
                        if (typeof cv !== 'undefined' && cv.Mat) {
                            clearInterval(checkCv);
                            isCvReady = true;
                            console.log("OpenCV.js HazÄ±r.");
                        }
                    }, 100);
                }
            }
        }

        /**
         * Canvas'tan Base64 verisini alÄ±r ve mimeType'Ä± ve sadece data kÄ±smÄ±nÄ± dÃ¶ndÃ¼rÃ¼r.
         * @param {HTMLCanvasElement} canvas
         * @returns {{mimeType: string, data: string}} 
         */
        const getBase64DataFromCanvas = (canvas) => {
            const dataUrl = canvas.toDataURL('image/png');
            const [metadata, data] = dataUrl.split(',');
            const mimeTypeMatch = metadata.match(/data:([^;]+)/);
            const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/png';
            return { mimeType, data };
        };

        // Canny Kenar Tespiti
        const processCanny = async (imgElement) => {
            if (!isCvReady) {
                throw new Error("OpenCV.js henÃ¼z hazÄ±r deÄŸil.");
            }

            // cv.Mat kullanarak iÅŸleme
            let src = cv.imread(imgElement);
            let dst = new cv.Mat();
            let gray = new cv.Mat();

            // Renkliden griye Ã§evir
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Canny kenar tespiti uygula
            cv.Canny(gray, dst, 50, 150, 3, false); 

            // Ä°ÅŸlenmiÅŸ matrisi tuvale yaz
            cv.imshow(cannyCanvas, dst);

            // Temizleme
            src.delete(); gray.delete(); dst.delete();

            // Canny tuvalini dÃ¶ndÃ¼r
            return cannyCanvas;
        };
        
        // Ãœretim iÃ§in gecikmeli fetch (Ã¼stel geri Ã§ekilme) - Sadece USE_GEMINI_API TRUE ise kullanÄ±lÄ±r
        const fetchWithRetry = async (url, options, maxRetries = 3) => {
            if (!USE_GEMINI_API) return; // API kapalÄ±ysa bu fonksiyon Ã§alÄ±ÅŸmaz
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429) {
                        // Too Many Requests - Ãœstel geri Ã§ekilme
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`API hÄ±zÄ± aÅŸÄ±ldÄ± (429). Yeniden deneme ${i + 1}/${maxRetries} (${delay.toFixed(0)}ms sonra).`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        throw new Error(`API hatasÄ±: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`AÄŸ hatasÄ±. Yeniden deneme ${i + 1}/${maxRetries} (${delay.toFixed(0)}ms sonra).`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API Ã§aÄŸrÄ±sÄ± maksimum yeniden deneme sayÄ±sÄ±na ulaÅŸtÄ±.");
        };


        // GÃ¶rsel Ãœretim AkÄ±ÅŸÄ±
        const generateImage = async (sceneType, useAlternative = false) => {
            hideMessage();
            resultOverlay.classList.remove('hidden');
            resultImage.classList.add('opacity-0');
            alternativeScenesContainer.classList.add('hidden');
            overlayText.textContent = useAlternative ? 
                `Alternatif Sahne (${SCENE_NAMES_TR[sceneType]}) OluÅŸturuluyor...` : 
                'Ä°ÅŸleniyor, lÃ¼tfen bekleyin...';

            if (!currentSketchFile) {
                showMessage("LÃ¼tfen Ã¶nce bir eskiz gÃ¶rseli yÃ¼kleyin.", 'error');
                setGenerating(false);
                resultOverlay.classList.remove('hidden');
                resultImage.classList.add('opacity-0');
                return;
            }

            const prompt = promptText.value.trim();
            if (!prompt) {
                showMessage("LÃ¼tfen Malzeme/Stil metnini (Prompt) girin.", 'error');
                setGenerating(false);
                resultOverlay.classList.remove('hidden');
                resultImage.classList.add('opacity-0');
                return;
            }

            // Gecikme ayarÄ±
            const generationDelay = 500; 

            if (isWebGPUSupported) {
                // YEREL (WebGPU) Modu AkÄ±ÅŸÄ±
                let base64Data = null;
                try {
                    overlayText.textContent = '1/3: Kenar HaritasÄ± Ã‡Ä±karÄ±lÄ±yor (OpenCV.js)...';
                    setGenerating(true);

                    // 1. OpenCV Canny Kenar Tespiti (Yerel Ä°ÅŸlem)
                    const cannyCanvas = await processCanny(sketchPreview);

                    if (USE_GEMINI_API) {
                        // KOTA KULLANAN YOL (FotogerÃ§ekÃ§i Ã‡Ä±ktÄ±)
                        
                        overlayText.textContent = '2/3: GÃ¶rÃ¼ntÃ¼ Ãœretimi BaÅŸlatÄ±lÄ±yor (API KotasÄ± KullanÄ±lÄ±yor)...';
                        await new Promise(r => setTimeout(r, generationDelay));
                        
                        const cannyData = getBase64DataFromCanvas(cannyCanvas);
                        
                        const fullPrompt = `Bu Canny kenar haritasÄ±nÄ±, fotogerÃ§ekÃ§i, yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼klÃ¼ bir mimari gÃ¶rsele dÃ¶nÃ¼ÅŸtÃ¼r. Stil: ${sceneType} atmosferi, ${prompt}. Kenar haritasÄ±na sadÄ±k kal.`;

                        const apiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                        
                        const payload = { 
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: fullPrompt },
                                    {
                                        inlineData: {
                                            mimeType: cannyData.mimeType,
                                            data: cannyData.data // Base64 kodlanmÄ±ÅŸ Canny verisi
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ['IMAGE']
                            }
                        };
                        
                        const response = await fetchWithRetry(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0) {
                            const imagePart = result.candidates[0].content.parts.find(p => p.inlineData && p.inlineData.mimeType.startsWith('image/'));
                            if (imagePart) {
                                base64Data = imagePart.inlineData.data;
                            }
                        }

                        if (!base64Data) {
                            const errorMessage = result.error?.message || "API'den geÃ§erli gÃ¶rsel verisi alÄ±namadÄ±.";
                            throw new Error(errorMessage);
                        }
                        
                        resultImage.src = `data:image/png;base64,${base64Data}`;
                        cannyCanvas.classList.add('hidden'); // Canny'yi gizle
                        sketchPreviewContainer.classList.remove('hidden'); // Orijinal eskizi gÃ¶ster 

                    } else {
                        // KOTA KULLANMAYAN YOL (Canny Ã‡Ä±ktÄ±sÄ±)
                        
                        overlayText.textContent = `2/3: FotogerÃ§ekÃ§i Ãœretim KAPALI. Canny Kenar HaritasÄ± GÃ¶steriliyor.`;
                        await new Promise(r => setTimeout(r, 1000));
                        
                        // Canny Ã§Ä±ktÄ±sÄ±nÄ± doÄŸrudan gÃ¶ster (100% Yerel)
                        resultImage.src = cannyCanvas.toDataURL('image/png');
                        
                        cannyCanvas.classList.remove('hidden'); 
                        sketchPreviewContainer.classList.add('hidden'); 
                    }

                    overlayText.textContent = `3/3: Ä°ÅŸlem TamamlandÄ±.`;
                    await new Promise(r => setTimeout(r, 500));


                } catch (e) {
                    console.error("Yerel/API Ãœretim HatasÄ±:", e);
                    showMessage(`GÃ¶rÃ¼ntÃ¼ Ã¼retimi sÄ±rasÄ±nda kritik bir hata oluÅŸtu: ${e.message}. DEMO moduna dÃ¼ÅŸÃ¼lÃ¼yor...`, 'error');
                    
                    // Hata durumunda DEMO moduna dÃ¼ÅŸme
                    const demoUrls = DEMO_LIBRARY[sceneType];
                    const randomUrl = randomChoice(demoUrls);
                    resultImage.src = randomUrl;
                    cannyCanvas.classList.add('hidden');
                    sketchPreviewContainer.classList.remove('hidden');
                }

            } else {
                // DEMO Modu AkÄ±ÅŸÄ± (WebGPU YOK)
                
                overlayText.textContent = 'DEMO Modu: Rastgele GÃ¶rsel SeÃ§iliyor...';
                
                // 1. DEMO_LIBRARY'den rastgele gÃ¶rsel seÃ§
                const demoUrls = DEMO_LIBRARY[sceneType];
                if (!demoUrls || demoUrls.length === 0) {
                    showMessage("SeÃ§ilen sahne tipi iÃ§in demo gÃ¶rseli bulunamadÄ±.", 'error');
                    setGenerating(false);
                    return;
                }
                const randomUrl = randomChoice(demoUrls);
                
                // 2. Gecikme (SimÃ¼lasyon)
                await new Promise(r => setTimeout(r, 1000));

                // 3. GÃ¶rseli gÃ¶ster
                resultImage.src = randomUrl;
                cannyCanvas.classList.add('hidden');
                sketchPreviewContainer.classList.remove('hidden'); // Orijinal eskizi tut
            }

            // BaÅŸarÄ±lÄ± Ã‡Ä±ktÄ± YÃ¶netimi
            setGenerating(false);
            resultOverlay.classList.add('hidden');
            resultImage.classList.remove('opacity-0');
            updateAlternativeButtons(sceneType);
            alternativeScenesContainer.classList.remove('hidden');
            
            // SeÃ§ilen sahneyi gÃ¼ncel tut
            selectedScene = sceneType;
        };

        // Alternatif ButonlarÄ± GÃ¼ncelleme
        const updateAlternativeButtons = (currentScene) => {
            alternativeButtonsContainer.innerHTML = '';
            const allScenes = Object.keys(DEMO_LIBRARY);
            const alternatives = allScenes.filter(s => s !== currentScene);

            alternatives.forEach(scene => {
                const button = document.createElement('button');
                button.className = 'alternative-button w-full py-2 px-3 border border-gray-300 rounded-xl shadow-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-[1.02]';
                button.textContent = SCENE_NAMES_TR[scene];
                button.setAttribute('data-scene', scene);
                button.addEventListener('click', () => {
                    setGenerating(true);
                    // Alternatif buton tÄ±klanÄ±rsa, yeni sahne tipiyle tekrar oluÅŸtur
                    generateImage(scene, true);
                });
                alternativeButtonsContainer.appendChild(button);
            });
        };

        // Olay Dinleyicileri

        // 1. Dosya YÃ¼kleme ve Ã–nizleme
        const handleFile = (file) => {
            hideMessage();

            if (file && file.size > MAX_FILE_SIZE_BYTES) {
                showMessage("Hata: Dosya boyutu 5MB'Ä± aÅŸÄ±yor.", 'error');
                return;
            }
            if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg')) {
                currentSketchFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    sketchPreview.src = e.target.result;
                    sketchPreviewContainer.classList.remove('hidden');
                    cannyCanvas.classList.add('hidden'); // Canny Ã§Ä±ktÄ±sÄ±nÄ± gizle
                };
                reader.readAsDataURL(file);
                fileDropArea.classList.remove('border-red-500');
            } else if (file) {
                showMessage("Hata: Sadece PNG veya JPG/JPEG dosyalarÄ± desteklenmektedir.", 'error');
            }
        };

        fileDropArea.addEventListener('click', () => sketchFile.click());
        sketchFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        // SÃ¼rÃ¼kle-BÄ±rak OlaylarÄ±
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('border-indigo-500'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('border-indigo-500'), false);
        });

        fileDropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        });

        clearSketchButton.addEventListener('click', () => {
            currentSketchFile = null;
            sketchFile.value = '';
            sketchPreviewContainer.classList.add('hidden');
            cannyCanvas.classList.add('hidden');
            fileDropArea.classList.remove('border-red-500');
            resultImage.src = "https://placehold.co/800x450/e0e0e0/555?text=SonuÃ§+Burada+GÃ¶zÃ¼kecek";
            alternativeScenesContainer.classList.add('hidden');
            resultOverlay.classList.remove('hidden');
            overlayText.textContent = 'LÃ¼tfen bir eskiz yÃ¼kleyin ve "OluÅŸtur"a tÄ±klayÄ±n.';
            hideMessage();
        });

        // 2. Sahne Tipi SeÃ§imi (Radio Button SimÃ¼lasyonu)
        document.querySelectorAll('.scene-option-label').forEach(label => {
            label.addEventListener('click', () => {
                document.querySelectorAll('.scene-option-label').forEach(l => l.classList.remove('bg-indigo-600', 'text-white'));
                label.classList.add('bg-indigo-600', 'text-white');
                selectedScene = label.getAttribute('data-scene');
            });
            // Ä°lkini varsayÄ±lan olarak seÃ§
            if (label.getAttribute('data-scene') === 'OutdoorDay') {
                 label.classList.add('bg-indigo-600', 'text-white');
            }
        });
        
        // Tailwind stilini ekle
        document.querySelectorAll('.scene-option-label').forEach(label => {
            label.classList.add('py-2', 'px-4', 'rounded-xl', 'cursor-pointer', 'shadow-sm', 'border', 'border-gray-300', 'text-sm', 'font-medium', 'text-gray-700', 'text-center', 'hover:bg-gray-50', 'transition');
        });


        // 3. OluÅŸtur Butonu
        generateButton.addEventListener('click', () => {
            if (!currentSketchFile) {
                showMessage("LÃ¼tfen bir eskiz gÃ¶rseli yÃ¼kleyin.", 'error');
                fileDropArea.classList.add('border-red-500');
                return;
            }
            if (!promptText.value.trim()) {
                showMessage("LÃ¼tfen Malzeme/Stil metnini (Prompt) girin.", 'error');
                promptText.focus();
                return;
            }

            // BaÅŸlatma
            setGenerating(true);
            generateImage(selectedScene, false);
        });

        // BaÅŸlangÄ±Ã§ Durumu
        resultImage.classList.add('opacity-0');
        resultOverlay.classList.remove('hidden');
    </script>
</body>
</html>
