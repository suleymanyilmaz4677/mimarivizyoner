<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Görsel Prototip: Eskizden Gerçekliğe</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <!-- OpenCV.js CDN (Canny Edge Detection için gerekli) -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <div id="status-ribbon" class="mb-6 p-3 rounded-xl shadow-lg font-semibold text-center transition-all duration-300">
        <!-- Buraya dinamik olarak WebGPU veya DEMO durumu yazılacak -->
    </div>

    <main class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Sol Panel: Giriş ve Ayarlar -->
        <div class="lg:col-span-1 space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-4">Eskiz & Stil Girişi</h1>

            <!-- Durum ve Hata Mesajları -->
            <div id="message-box" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

            <!-- 1. Eskiz Yükleme -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">1. Eskiz Yükle (PNG/JPG, maks 5MB)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-500 transition" id="file-drop-area">
                    <input id="sketch-file" type="file" accept=".png, .jpg, .jpeg" class="hidden">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m-4-4h4m-4 0v4m-4-4l3.172-3.172a4 4 0 005.656 0L36 32" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium text-indigo-600 hover:text-indigo-500">Tıkla yükle</span> veya sürükle bırak
                        </p>
                        <p class="text-xs text-gray-500">PNG, JPG</p>
                    </div>
                </div>
            </div>

            <!-- Eskiz Önizleme -->
            <div id="sketch-preview-container" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Önizleme</label>
                <img id="sketch-preview" class="w-full h-auto rounded-lg shadow-md border object-cover" src="#" alt="Eskiz Önizlemesi">
                <button id="clear-sketch" class="mt-2 text-xs text-red-600 hover:text-red-800 transition">Eskizi Temizle</button>
            </div>
            <!-- Canny çıktısı, API'ye göndermeden önce base64'e çevrilecek buradan okunacak -->
            <canvas id="canny-canvas" class="hidden w-full h-auto rounded-lg shadow-md border object-cover"></canvas> 

            <!-- 2. Stil Metni (Prompt) -->
            <div>
                <label for="prompt-text" class="block text-sm font-medium text-gray-700 mb-2">2. Malzeme ve Stil (Prompt)</label>
                <textarea id="prompt-text" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="Örn: 'Rustik ahşap cephe, çatı katı pencereleri, sonbahar yaprakları.'"></textarea>
            </div>

            <!-- 3. Sahne Tipi -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">3. Sahne Tipi Seç</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="scene-option-label" data-scene="OutdoorDay">Gündüz (Dış Mekan)</label>
                    <label class="scene-option-label" data-scene="OutdoorSunset">Günbatımı (Dış Mekan)</label>
                    <label class="scene-option-label" data-scene="OutdoorNight">Gece (Dış Mekan)</label>
                    <label class="scene-option-label" data-scene="Indoor">İç Mekan</label>
                </div>
            </div>

            <!-- Oluştur Butonu -->
            <button id="generate-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-[1.01]">
                <span id="generate-text">Görsel Oluştur</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            </button>
        </div>

        <!-- Sağ Panel: Sonuç Görseli ve Alternatifler -->
        <div class="lg:col-span-2 space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-4">Sonuç Görseli</h2>

            <!-- Sonuç Görseli -->
            <div class="relative bg-gray-200 rounded-xl overflow-hidden shadow-xl aspect-video flex items-center justify-center p-4">
                <img id="result-image" class="w-full h-full object-contain rounded-lg" src="https://placehold.co/800x450/e0e0e0/555?text=Sonuç+Burada+Gözükecek" alt="Üretim Sonucu">
                <div id="result-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-70 text-white flex items-center justify-center rounded-xl transition duration-300 hidden">
                    <span id="overlay-text" class="text-xl font-semibold text-center">Lütfen bir eskiz yükleyin ve "Oluştur"a tıklayın.</span>
                </div>
            </div>

            <!-- Alternatif Sahne Butonları -->
            <div id="alternative-scenes" class="pt-4 border-t hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Alternatif Sahne Denemeleri</h3>
                <div class="grid grid-cols-3 gap-4" id="alternative-buttons-container">
                    <!-- Alternatif butonlar buraya JS ile yüklenecek -->
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Zorunlu Global Değişkenler (Canvas ortamı için)
        const appId = window.__app_id || 'default-app-id';
        const firebaseConfigRaw = window.__firebase_config;
        let firebaseConfig = {};
        if (firebaseConfigRaw) {
            try {
                // @ts-ignore
                firebaseConfig = JSON.parse(firebaseConfigRaw);
            } catch (e) {
                console.error("Firebase config çözümlemesi hatası:", e);
            }
        }
        const initialAuthToken = window.__initial_auth_token || null;


        // KONTROL BAYRAĞI: API kullanımını tamamen kapatmak için
        // FALSE ise, WebGPU destekli cihazlarda sadece Canny çıktısı gösterilir (100% kotasız).
        const USE_GEMINI_API = false; 

        // Sabitler
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5MB
        const DEMO_LIBRARY = {
            OutdoorDay: ['/demo-samples/outdoor-day-1.jpg','/demo-samples/outdoor-day-2.jpg'],
            OutdoorSunset: ['/demo-samples/outdoor-sunset-1.jpg','/demo-samples/outdoor-sunset-2.jpg'],
            OutdoorNight: ['/demo-samples/outdoor-night-1.jpg','/demo-samples/outdoor-night-2.jpg'],
            Indoor: ['/demo-samples/indoor-1.jpg','/demo-samples/indoor-2.jpg','/demo-samples/indoor-3.jpg'],
        };
        const SCENE_NAMES_TR = {
            OutdoorDay: "Gündüz (Dış Mekan)",
            OutdoorSunset: "Günbatımı",
            OutdoorNight: "Gece (Dış Mekan)",
            Indoor: "İç Mekan",
        };

        // UI Elementleri
        const sketchFile = document.getElementById('sketch-file');
        const fileDropArea = document.getElementById('file-drop-area');
        const sketchPreview = document.getElementById('sketch-preview');
        const sketchPreviewContainer = document.getElementById('sketch-preview-container');
        const clearSketchButton = document.getElementById('clear-sketch');
        const cannyCanvas = document.getElementById('canny-canvas');
        const promptText = document.getElementById('prompt-text');
        const generateButton = document.getElementById('generate-button');
        const generateText = document.getElementById('generate-text');
        const spinner = document.getElementById('spinner');
        const resultImage = document.getElementById('result-image');
        const messageBox = document.getElementById('message-box');
        const statusRibbon = document.getElementById('status-ribbon');
        const resultOverlay = document.getElementById('result-overlay');
        const overlayText = document.getElementById('overlay-text');
        const alternativeButtonsContainer = document.getElementById('alternative-buttons-container');
        const alternativeScenesContainer = document.getElementById('alternative-scenes');

        // Durum Yönetimi
        let currentSketchFile = null;
        let selectedScene = 'OutdoorDay';
        let isWebGPUSupported = false;
        let isCvReady = false;

        // Helper Fonksiyonlar
        const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const showMessage = (text, type = 'error') => {
            messageBox.textContent = text;
            messageBox.className = `p-3 text-sm rounded-xl transition duration-300 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.classList.remove('hidden');
        };
        const hideMessage = () => messageBox.classList.add('hidden');
        const setGenerating = (isGenerating) => {
            generateButton.disabled = isGenerating;
            spinner.classList.toggle('hidden', !isGenerating);
            generateText.textContent = isGenerating ? 'Oluşturuluyor...' : 'Görsel Oluştur';
        };

        // WebGPU Kontrolü ve Modu Belirleme
        const checkWebGPU = () => {
            // @ts-ignore
            isWebGPUSupported = navigator.gpu != null;

            if (isWebGPUSupported) {
                if (USE_GEMINI_API) {
                    statusRibbon.textContent = "✅ YEREL Mod (API Destekli Üretim): Canvas Kotası kullanılarak fotogerçekçi çıktı alınır.";
                    statusRibbon.classList.add('bg-green-200', 'text-green-800');
                } else {
                    // Kullanıcının talep ettiği 100% kotasız, statik mod.
                    statusRibbon.textContent = "💻 YEREL Mod (Canny Çıktısı): API çağrısı KAPALI. Sadece OpenCV çıktısı gösterilir.";
                    statusRibbon.classList.add('bg-blue-200', 'text-blue-800');
                }
            } else {
                statusRibbon.textContent = "❌ DEMO Modu: WebGPU Desteklenmiyor. Önceden yüklenmiş görseller kullanılacak.";
                statusRibbon.classList.add('bg-yellow-200', 'text-yellow-800');
                isCvReady = true; 
            }
        };

        // OpenCV Hazır Olma Durumu
        window.onload = function() {
            checkWebGPU();

            if (isWebGPUSupported) {
                // Sadece WebGPU destekleniyorsa OpenCV'nin yüklenmesini bekleriz.
                // @ts-ignore
                if (typeof cv !== 'undefined') {
                    isCvReady = true;
                } else {
                    const checkCv = setInterval(() => {
                        // @ts-ignore
                        if (typeof cv !== 'undefined' && cv.Mat) {
                            clearInterval(checkCv);
                            isCvReady = true;
                            console.log("OpenCV.js Hazır.");
                        }
                    }, 100);
                }
            }
        }

        /**
         * Canvas'tan Base64 verisini alır ve mimeType'ı ve sadece data kısmını döndürür.
         * @param {HTMLCanvasElement} canvas
         * @returns {{mimeType: string, data: string}} 
         */
        const getBase64DataFromCanvas = (canvas) => {
            const dataUrl = canvas.toDataURL('image/png');
            const [metadata, data] = dataUrl.split(',');
            const mimeTypeMatch = metadata.match(/data:([^;]+)/);
            const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/png';
            return { mimeType, data };
        };

        // Canny Kenar Tespiti
        const processCanny = async (imgElement) => {
            if (!isCvReady) {
                throw new Error("OpenCV.js henüz hazır değil.");
            }

            // cv.Mat kullanarak işleme
            let src = cv.imread(imgElement);
            let dst = new cv.Mat();
            let gray = new cv.Mat();

            // Renkliden griye çevir
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Canny kenar tespiti uygula
            cv.Canny(gray, dst, 50, 150, 3, false); 

            // İşlenmiş matrisi tuvale yaz
            cv.imshow(cannyCanvas, dst);

            // Temizleme
            src.delete(); gray.delete(); dst.delete();

            // Canny tuvalini döndür
            return cannyCanvas;
        };
        
        // Üretim için gecikmeli fetch (üstel geri çekilme) - Sadece USE_GEMINI_API TRUE ise kullanılır
        const fetchWithRetry = async (url, options, maxRetries = 3) => {
            if (!USE_GEMINI_API) return; // API kapalıysa bu fonksiyon çalışmaz
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    } else if (response.status === 429) {
                        // Too Many Requests - Üstel geri çekilme
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`API hızı aşıldı (429). Yeniden deneme ${i + 1}/${maxRetries} (${delay.toFixed(0)}ms sonra).`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        throw new Error(`API hatası: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Ağ hatası. Yeniden deneme ${i + 1}/${maxRetries} (${delay.toFixed(0)}ms sonra).`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API çağrısı maksimum yeniden deneme sayısına ulaştı.");
        };


        // Görsel Üretim Akışı
        const generateImage = async (sceneType, useAlternative = false) => {
            hideMessage();
            resultOverlay.classList.remove('hidden');
            resultImage.classList.add('opacity-0');
            alternativeScenesContainer.classList.add('hidden');
            overlayText.textContent = useAlternative ? 
                `Alternatif Sahne (${SCENE_NAMES_TR[sceneType]}) Oluşturuluyor...` : 
                'İşleniyor, lütfen bekleyin...';

            if (!currentSketchFile) {
                showMessage("Lütfen önce bir eskiz görseli yükleyin.", 'error');
                setGenerating(false);
                resultOverlay.classList.remove('hidden');
                resultImage.classList.add('opacity-0');
                return;
            }

            const prompt = promptText.value.trim();
            if (!prompt) {
                showMessage("Lütfen Malzeme/Stil metnini (Prompt) girin.", 'error');
                setGenerating(false);
                resultOverlay.classList.remove('hidden');
                resultImage.classList.add('opacity-0');
                return;
            }

            // Gecikme ayarı
            const generationDelay = 500; 

            if (isWebGPUSupported) {
                // YEREL (WebGPU) Modu Akışı
                let base64Data = null;
                try {
                    overlayText.textContent = '1/3: Kenar Haritası Çıkarılıyor (OpenCV.js)...';
                    setGenerating(true);

                    // 1. OpenCV Canny Kenar Tespiti (Yerel İşlem)
                    const cannyCanvas = await processCanny(sketchPreview);

                    if (USE_GEMINI_API) {
                        // KOTA KULLANAN YOL (Fotogerçekçi Çıktı)
                        
                        overlayText.textContent = '2/3: Görüntü Üretimi Başlatılıyor (API Kotası Kullanılıyor)...';
                        await new Promise(r => setTimeout(r, generationDelay));
                        
                        const cannyData = getBase64DataFromCanvas(cannyCanvas);
                        
                        const fullPrompt = `Bu Canny kenar haritasını, fotogerçekçi, yüksek çözünürlüklü bir mimari görsele dönüştür. Stil: ${sceneType} atmosferi, ${prompt}. Kenar haritasına sadık kal.`;

                        const apiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                        
                        const payload = { 
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: fullPrompt },
                                    {
                                        inlineData: {
                                            mimeType: cannyData.mimeType,
                                            data: cannyData.data // Base64 kodlanmış Canny verisi
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ['IMAGE']
                            }
                        };
                        
                        const response = await fetchWithRetry(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0) {
                            const imagePart = result.candidates[0].content.parts.find(p => p.inlineData && p.inlineData.mimeType.startsWith('image/'));
                            if (imagePart) {
                                base64Data = imagePart.inlineData.data;
                            }
                        }

                        if (!base64Data) {
                            const errorMessage = result.error?.message || "API'den geçerli görsel verisi alınamadı.";
                            throw new Error(errorMessage);
                        }
                        
                        resultImage.src = `data:image/png;base64,${base64Data}`;
                        cannyCanvas.classList.add('hidden'); // Canny'yi gizle
                        sketchPreviewContainer.classList.remove('hidden'); // Orijinal eskizi göster 

                    } else {
                        // KOTA KULLANMAYAN YOL (Canny Çıktısı)
                        
                        overlayText.textContent = `2/3: Fotogerçekçi Üretim KAPALI. Canny Kenar Haritası Gösteriliyor.`;
                        await new Promise(r => setTimeout(r, 1000));
                        
                        // Canny çıktısını doğrudan göster (100% Yerel)
                        resultImage.src = cannyCanvas.toDataURL('image/png');
                        
                        cannyCanvas.classList.remove('hidden'); 
                        sketchPreviewContainer.classList.add('hidden'); 
                    }

                    overlayText.textContent = `3/3: İşlem Tamamlandı.`;
                    await new Promise(r => setTimeout(r, 500));


                } catch (e) {
                    console.error("Yerel/API Üretim Hatası:", e);
                    showMessage(`Görüntü üretimi sırasında kritik bir hata oluştu: ${e.message}. DEMO moduna düşülüyor...`, 'error');
                    
                    // Hata durumunda DEMO moduna düşme
                    const demoUrls = DEMO_LIBRARY[sceneType];
                    const randomUrl = randomChoice(demoUrls);
                    resultImage.src = randomUrl;
                    cannyCanvas.classList.add('hidden');
                    sketchPreviewContainer.classList.remove('hidden');
                }

            } else {
                // DEMO Modu Akışı (WebGPU YOK)
                
                overlayText.textContent = 'DEMO Modu: Rastgele Görsel Seçiliyor...';
                
                // 1. DEMO_LIBRARY'den rastgele görsel seç
                const demoUrls = DEMO_LIBRARY[sceneType];
                if (!demoUrls || demoUrls.length === 0) {
                    showMessage("Seçilen sahne tipi için demo görseli bulunamadı.", 'error');
                    setGenerating(false);
                    return;
                }
                const randomUrl = randomChoice(demoUrls);
                
                // 2. Gecikme (Simülasyon)
                await new Promise(r => setTimeout(r, 1000));

                // 3. Görseli göster
                resultImage.src = randomUrl;
                cannyCanvas.classList.add('hidden');
                sketchPreviewContainer.classList.remove('hidden'); // Orijinal eskizi tut
            }

            // Başarılı Çıktı Yönetimi
            setGenerating(false);
            resultOverlay.classList.add('hidden');
            resultImage.classList.remove('opacity-0');
            updateAlternativeButtons(sceneType);
            alternativeScenesContainer.classList.remove('hidden');
            
            // Seçilen sahneyi güncel tut
            selectedScene = sceneType;
        };

        // Alternatif Butonları Güncelleme
        const updateAlternativeButtons = (currentScene) => {
            alternativeButtonsContainer.innerHTML = '';
            const allScenes = Object.keys(DEMO_LIBRARY);
            const alternatives = allScenes.filter(s => s !== currentScene);

            alternatives.forEach(scene => {
                const button = document.createElement('button');
                button.className = 'alternative-button w-full py-2 px-3 border border-gray-300 rounded-xl shadow-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-[1.02]';
                button.textContent = SCENE_NAMES_TR[scene];
                button.setAttribute('data-scene', scene);
                button.addEventListener('click', () => {
                    setGenerating(true);
                    // Alternatif buton tıklanırsa, yeni sahne tipiyle tekrar oluştur
                    generateImage(scene, true);
                });
                alternativeButtonsContainer.appendChild(button);
            });
        };

        // Olay Dinleyicileri

        // 1. Dosya Yükleme ve Önizleme
        const handleFile = (file) => {
            hideMessage();

            if (file && file.size > MAX_FILE_SIZE_BYTES) {
                showMessage("Hata: Dosya boyutu 5MB'ı aşıyor.", 'error');
                return;
            }
            if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg')) {
                currentSketchFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    sketchPreview.src = e.target.result;
                    sketchPreviewContainer.classList.remove('hidden');
                    cannyCanvas.classList.add('hidden'); // Canny çıktısını gizle
                };
                reader.readAsDataURL(file);
                fileDropArea.classList.remove('border-red-500');
            } else if (file) {
                showMessage("Hata: Sadece PNG veya JPG/JPEG dosyaları desteklenmektedir.", 'error');
            }
        };

        fileDropArea.addEventListener('click', () => sketchFile.click());
        sketchFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        // Sürükle-Bırak Olayları
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('border-indigo-500'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('border-indigo-500'), false);
        });

        fileDropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        });

        clearSketchButton.addEventListener('click', () => {
            currentSketchFile = null;
            sketchFile.value = '';
            sketchPreviewContainer.classList.add('hidden');
            cannyCanvas.classList.add('hidden');
            fileDropArea.classList.remove('border-red-500');
            resultImage.src = "https://placehold.co/800x450/e0e0e0/555?text=Sonuç+Burada+Gözükecek";
            alternativeScenesContainer.classList.add('hidden');
            resultOverlay.classList.remove('hidden');
            overlayText.textContent = 'Lütfen bir eskiz yükleyin ve "Oluştur"a tıklayın.';
            hideMessage();
        });

        // 2. Sahne Tipi Seçimi (Radio Button Simülasyonu)
        document.querySelectorAll('.scene-option-label').forEach(label => {
            label.addEventListener('click', () => {
                document.querySelectorAll('.scene-option-label').forEach(l => l.classList.remove('bg-indigo-600', 'text-white'));
                label.classList.add('bg-indigo-600', 'text-white');
                selectedScene = label.getAttribute('data-scene');
            });
            // İlkini varsayılan olarak seç
            if (label.getAttribute('data-scene') === 'OutdoorDay') {
                 label.classList.add('bg-indigo-600', 'text-white');
            }
        });
        
        // Tailwind stilini ekle
        document.querySelectorAll('.scene-option-label').forEach(label => {
            label.classList.add('py-2', 'px-4', 'rounded-xl', 'cursor-pointer', 'shadow-sm', 'border', 'border-gray-300', 'text-sm', 'font-medium', 'text-gray-700', 'text-center', 'hover:bg-gray-50', 'transition');
        });


        // 3. Oluştur Butonu
        generateButton.addEventListener('click', () => {
            if (!currentSketchFile) {
                showMessage("Lütfen bir eskiz görseli yükleyin.", 'error');
                fileDropArea.classList.add('border-red-500');
                return;
            }
            if (!promptText.value.trim()) {
                showMessage("Lütfen Malzeme/Stil metnini (Prompt) girin.", 'error');
                promptText.focus();
                return;
            }

            // Başlatma
            setGenerating(true);
            generateImage(selectedScene, false);
        });

        // Başlangıç Durumu
        resultImage.classList.add('opacity-0');
        resultOverlay.classList.remove('hidden');
    </script>
</body>
</html>
